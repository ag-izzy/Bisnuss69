local base64MoneyIcon = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFoAAABaCAMAAAAPdrEwAAAAIGNIUk0AAHolAACAgwAA+f8AAIDpAAB1MAAA6mAAADqYAAAXb5JfxUYAAAMAUExURQAAACmvPCmwPCuwPiywPi2wPy6xQC6xQS+yQTCxQTCyQTCyQjGyQzKyRDOzRTSzRTSzRjW0RjW0Rza0SDe0STi0STm1Sjq1Szq2Szu2TDy2TDy2TT22Tj63Tz+3UEC4UEG4UUG4UkK4U0O5VES5VEW6VUa6Vke6V0i7WEm7WUu8Wku8W0y8W028XE29XU++XlC9X1C+X1G+YFK+YVO/YlW/ZFXAZFfAZVfAZljBZlnBZ1rBaVvCaVvCalzDal7CbF/DbV/EbWHEbmLEb2LEcGTFcWfGdGjHdWrHd2vId2vIeGzIeW3JenHKfXLKfnPLf3TLgHXLgXXMgHXMgXbMgnjNg3nMhHrNhnrOhnzOiH7PiYLQjYPRjoTRjoTRj4XRkIXSkIfSkojSk4rUlYzUlo7VmJDWmpHWm5LXnJTXnZTXnpXYnpbYn5nZopzapJ3bpZ7bpp7bp6DcqKLcqqPcq6Tcq6TdrKberqjfr6jfsKnfsavgs6zgs6zgtK7hta/htrDit7LiuLLiubPjurTjurXju7bkvLbkvbnlv7rlwLrmwLzmwr3nw77nxMDnxcLox8PpyMTpycXpysXqysbqy8fqzMnrzcrrz8vsz8vs0Mzs0c3t0tHu1dHu1tPv19Tv2NXv2dXw2dbw2tfw29jw3Nnx3drx3t7z4d/z4uD04+H05OP15eP15uT15uT15+X16OX26Of26en36+r37Ov37er47Ov47ez47e347u347+758PD58fD68fD68vL69PT79fX79vb79/b89vb89/f8+Pj9+fn9+vr9+/v++/v+/Pz+/P3+/f3+/v7//wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAALfZHJgAAAEAdFJOU////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////wBT9wclAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAGHRFWHRTb2Z0d2FyZQBwYWludC5uZXQgNC4xLjb9TgnoAAAGdUlEQVRoQ7WZ93sURRiAFZO76O1eklt215OgBwqJgmgCRhAhRrAAiogBK4gBJEFEgWAEYiGIYEGp1kjXQECkiF0OWyjJ/k34zcy3db7Zu8fHe3/KTXnzPbPT56orRTEYAhMLUFgNKkeiGH8BNaV1KWSPVXveU9s3LW9pvhdoblm+afspTHZi5Wo1BnzpaOfcnFmWSBv29YBtpBNlZm5u59FLPDsmdJUaxQeXNugZw5IwMnrD0oO8iFKuUHNx/+bGZLWNMgm7Otm4uZ/LsVIEUs3F+Y5a3USNAlOv7cgr5ZSamQffyOnKgH1sPdfFi2PVILKaReEcmKwVIWbY2uQDvApW95HULIb+Ng0rFoXWxppcCjyqZuZjk4oNWWBrk44R7oiamXdkC3w9GTO7Q3aH1cy8OkWFnHtitstM4j/bqdWSO6Rm5nYdS4e5FbKQwxlMC6G3Q1bIHVQz8+IKLBphJLdydlRjWpiKxZAXdAfUPOak4gOO4FZOdxWmhbGTkbh9NTOvoVsDuGmAaxkdlZgWRV8Dub7bV0PyzhQWkqk5z7WMdjpqILUTslEXUEPQJ7Lq7pz9WXiBZ4iZUGBnTwTCdtVgvjgxpj+b3vTvTEteq5KbEy/6blcNVZapR3cmdc9Z4QV6Pnxzdr1GF9aWQQFUohqCPqQc3ZV17X3C6tP31kyL+Jy2dsgLW6jBPDgVc6OkR3XxCV/i9IqRRFedylxc6qk30L3DNF7ikz1Jft0oLOaT2hBSg/l8jmwOo24/amimYzkfOwfdlLtdNT1YjIaf0EFzgGhuNnB8teNcqCWDvs3vzSSLqC9Ze0F0EqaGoDeSQWt7UaHgXA0WDKFvFGEzNRS6mxot6VZhUNJNdm7zbsgSagj6UAKTQ5hnhEHJffRISIi+LdRLyNn9cTSoOExP3FZmiat2nIF66t9Xb0GFz8Df+AenVTEF2vUwAzM1BN1LfsTkcVS4bJs+fnRj84z3joqf+eFYUELvZWFzdSfZHjeeEwqXl6/myWaZ0bSVDf3uJP9NkOn01HPISXIMTJAB/hiB6WBPN+xxBpvxl4wxR6ihll8pSL1QupwLLhR22YL9ysVGrKRcfZJeAu4QSo+1yWA3rla2NGCeZGpoj13lmBJm1F/odDm+fv68phorU0l+miDlu6BFmLqbHDCWdhqVQQb/zPesW1inqxdoRqIb1SvSmBJG+wR1BF+/NkmLWUnTK1DdQq+i5gvoIbn85QPqtdRoQfU0TIgy4h/UKOi+gZ5DgGmonqIoob2CDhXHblE0ij2lgNo2YMcSy7fkhF2E2rIm/IoOFV/Q+78i1JkJheJ+jOzjnlr1GRk18swa4iC9t3U/o6LzCVLTP4dlVM14LBfC63yKIYOYeuMqcRoneZFqEW/IKAY6Q8xumla3YP2+PNnNt1Jqb6Arpifg5kXuHjNTaVi1s5/eJs0r+6gFUkxP6kkV2mKBs8UMZSYMdmAJcpxqTTGpqpcCEO1znCMTwlPFNbuF0uUs1UVwKYAWoRcwGDHsbNS/algwu+J1bvToI9TuAgZqetm1roPVk/FDazbhjaryr0SiSw/R1oFll94sWNnfsLrzS1eTkawyjKrE6HcwyeVtIix3s6Dc4ljzsTbnx74P1na83+uf8ZBn5cb0tjgsbHJjlvoMa8dxWT4XBDZmoCa3k7eH9yE0u4l9jr+dZN2P2ASnVorK8TwoVwxsglnYxNY9852oHMseogMEt+4QtnzgGDoTa8eRH4ulA4QOHCxs6ZhUBdNAIS7NIjp1+JgEaulwZzwsnXCjDDxPzB+Rwx1zS0fSoVZb/Mp4/lFqQxk5kjI1cZDWa179HTUEe8eRW9XoQZq5qeN/5fCFigWmd14VNRXLx3/et8lLC7N8XNtH0VP6mXfvV+z4iEsLFrbqqkXXho2Z8dynwgo8NdZK0SXpqxbmjrsgquhCsXrhgOYgL4h4k8Rca5VvFV7gTkySUVxrsbBjLuOGfMy1jCZFa6gv47hbeYU4ZA/XMmbRy13MFaJwqy4+Ez1cy3iSVsddfGLcdJvo33Ato5VcSeOva4WbvmQ2v+daxkrqfqXQJbNwk1fj9kOPuNwlZxdxNS7c5IW+MdRFMhd3oS/cpXmG4EOnRI8nAAt8sKsETz4AK1yahyqAy0vxvAaU7lEQcJ8yj9BPmUf+81MmR8iB//kBllOyZ2NOqR67XUAVABNjuXLlX2rCcoFjOcGoAAAAAElFTkSuQmCC'
local isInShopMenu = false
local tablet = false
local tabletDict = "amb@code_human_in_bus_passenger_idles@female@tablet@base"
local tabletAnim = "base"
local tabletProp = `prop_cs_tablet`
local tabletBone = 60309
local tabletOffset = vector3(0.03, 0.002, -0.0)
local tabletRot = vector3(10.0, 160.0, 0.0)
local storedJob = 'unemployed'

CreateThread(function()
	ESX.PlayerData = ESX.GetPlayerData()
end)

RegisterNetEvent('KKF.Player.JobUpdate')
AddEventHandler('KKF.Player.JobUpdate', function(job)
	ESX.PlayerData.job = job
end)

RegisterNetEvent('KKF.Player.Loaded')
AddEventHandler('KKF.Player.Loaded', function(xPlayer)
	ESX.PlayerData = xPlayer

	loadLoops()
end)

--RegisterCommand('manualLoad', function() loadLoops() end)

RegisterNetEvent('KKF.Player.DutyChange') AddEventHandler('KKF.Player.DutyChange', function(value) ESX.PlayerData.job.onDuty = value end)

AddEventHandler('kk-society:openBossMenu', function(society, close, options)
	showMdw()
end)

RegisterNUICallback("reloadAllData", function(args, cb)
	lib.callback('kk-society:loadBills', false, function(cb) 
		SendNUIMessage({ action = "loadBills", data = cb })
	end, ESX.PlayerData.job.name)
	
	lib.callback('kk-society:getEmployees', false, function(cb)
		SendNUIMessage({ action = "loadMembers", data = cb })
	end, ESX.PlayerData.job.name)

	lib.callback('kk-society:getVehicles', false, function(cb)
		SendNUIMessage({ action = "loadVehicles", data = cb })
	end, ESX.PlayerData.job.name)

	lib.callback('kk-society:getMoneyCompany', false, function(cb)
		SendNUIMessage({ action = "updateBankTabData", data = cb })
	end, ESX.PlayerData.job.name)

	lib.callback('kk-society:loadRanks', false, function(cb)
		SendNUIMessage({ action = "loadRanks", data = cb })
		SendNUIMessage({ action = "loadAllRanks", data = cb })
	end, ESX.PlayerData.job.name)

	lib.callback('kk-society:loadHome', false, function(cb)
		SendNUIMessage({ action = "updateHome", data = cb })
	end, ESX.PlayerData.job.name)
end)

function toggleTab(toggle)
    if toggle and not tablet then
        tablet = true

		if not IsPedInAnyVehicle(PlayerPedId(), false) then
			Citizen.CreateThread(function()
				lib.requestAnimDict(tabletDict)
				lib.requestModel(tabletProp)

				while not HasModelLoaded(tabletProp) do
					Citizen.Wait(150)
				end

				local playerPed = PlayerPedId()
				local tabletObj = CreateObject(tabletProp, 0.0, 0.0, 0.0, true, true, false)
				local tabletBoneIndex = GetPedBoneIndex(playerPed, tabletBone)

				SetCurrentPedWeapon(playerPed, `weapon_unarmed`, true)
				AttachEntityToEntity(tabletObj, playerPed, tabletBoneIndex, tabletOffset.x, tabletOffset.y, tabletOffset.z, tabletRot.x, tabletRot.y, tabletRot.z, true, false, false, false, 2, true)
				SetModelAsNoLongerNeeded(tabletProp)

				while tablet do
					Citizen.Wait(100)
					playerPed = PlayerPedId()

					if not IsEntityPlayingAnim(playerPed, tabletDict, tabletAnim, 3) then
						TaskPlayAnim(playerPed, tabletDict, tabletAnim, 3.0, 3.0, -1, 49, 0, 0, 0, 0)
					end
				end

				ClearPedSecondaryTask(playerPed)

				Citizen.Wait(450)

				DetachEntity(tabletObj, true, false)
				ESX.Game.DeleteEntity(tabletObj)
			end)
		end
    elseif not toggle and tablet then
        tablet = false
    end
end

function showMdw()
	SendNUIMessage({ action = "setJob", data = ESX.PlayerData.job.name })
    SendNUIMessage({ action = "openMdw", data = ESX.PlayerData.job.permissions})
	
    local isInVeh = IsPedInAnyVehicle(PlayerPedId(), false)

    if not isInVeh then
        SetPlayerControl(PlayerId(), 0, 0)
    end

    guiEnabled = true
    SetNuiFocus(true, true)

    toggleTab(true)
end

RegisterNUICallback("disableFocus", function(args, cb)
    if not guiEnabled then
        return
    end

    SetPlayerControl(PlayerId(), 1, 0)
    SetNuiFocus(false, false)

    guiEnabled = false

	toggleTab(false)
end) 

RegisterNUICallback("leaveSociety", function(args, cb)
	TriggerServerEvent('kk-society:server:leaveFromCompany')
end)

RegisterNUICallback("requestLogs", function(args, cb)
	lib.callback('kk-society:loadLogs', false, function(cb)
		SendNUIMessage({ action = "loadLogs", data = cb })
	end, args.pid, args.context)
end)

RegisterNUICallback("createNewRank", function(args, cb)
    TriggerServerEvent('kk-society:server:createNewRank', args.rankName)
end)

RegisterNUICallback("inviteToCompany", function(args, cb)
	TriggerServerEvent('kk-society:server:inviteToCompany', args.invitedCharacterId)
end)

RegisterNetEvent('kk-society:client:sendInvitation', function(data)
	if guiEnabled then return end
	storedJob = data[1]; SetNuiFocus(true, true)
	SendNUIMessage({ action = "invitationOpen", name = data[2] })
end)

RegisterNUICallback("acceptInvitation", function(args, cb)
    TriggerServerEvent('kk-society:server:acceptInvitation', storedJob)
	storedJob = 'unemployed'; SetNuiFocus(false, false)
end)

RegisterNUICallback("declineInvitation", function(args, cb)
	if storedJob == 'unemployed' then return end
    TriggerServerEvent('kk-society:server:declineInvitation')
	storedJob = 'unemployed'; SetNuiFocus(false, false)
end)

RegisterNUICallback("buyVehicle", function(args, cb)
	local plate = exports['kk-vehicleshop']:GeneratePlate()
    TriggerServerEvent('kk-society:server:buyVehicle', args.selectedId, plate)
end)

RegisterNUICallback("removeFromCompany", function(args, cb)
    TriggerServerEvent('kk-society:server:removeFromCompany', args.invitedCharacterId)
end)

RegisterNUICallback("changeRank", function(args, cb)
    TriggerServerEvent('kk-society:server:changeRank', args.invitedCharacterId, args.gradeId)
end)

RegisterNUICallback("userMoneyTransaction", function(args, cb)
	if exports['kk-banking']:isNearBank() then 
    	TriggerServerEvent('kk-society:server:moneyActions', args.amount, args.type)
	else
		TriggerEvent('kk-society:client:showNotify', 'Pank', 'Te ei ole pangas!', 'error')
	end
end)

RegisterNUICallback("loadEditRank", function(args, cb)
	lib.callback('kk-society:loadEditRank', false, function(cb)
		SendNUIMessage({ action = "updateRankEditSection", data = cb })
	end, args.rankId)
end)

RegisterNUICallback("deleteRank", function(args, cb)
	TriggerServerEvent('kk-society:server:deleteRank', tonumber(args.rankId))
end)

RegisterNUICallback("saveRank", function(args, cb)
	TriggerServerEvent('kk-society:server:saveRank', tonumber(args.rankId), tonumber(args.rankSalary), args.permissions)
end)

RegisterNUICallback("refreshHome", function(args, cb)
	lib.callback('kk-society:loadHome', false, function(cb)
		SendNUIMessage({ action = "updateHome", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNUICallback("refreshRanksButton", function(args, cb)
	lib.callback('kk-society:loadRanks', false, function(cb) 
		SendNUIMessage({ action = "loadRanks", data = cb })
		SendNUIMessage({ action = "loadAllRanks", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNUICallback("refreshMembersButton", function(args, cb)
	lib.callback('kk-society:getEmployees', false, function(cb)
		SendNUIMessage({ action = "loadMembers", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNUICallback("refreshBillsButton", function(args, cb)
	lib.callback('kk-society:loadBills', false, function(cb) 
		SendNUIMessage({ action = "loadBills", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNUICallback("openBadge", function(args, cb)
	local keyboard = lib.inputDialog('Ametitõendi redigeerimine', {'Seeria NR (1 - 99)', 'Osakond (BCSO või LSPD)'})

	if keyboard then
		local serial = keyboard[1]; local department = keyboard[2] 

        if serial and department then
			TriggerServerEvent('kk-society:server:editBadge', args.pid, {serial = serial, department = department})
		else
			TriggerEvent('KKF.UI.ShowNotification', 'error', 'Ametitõendi redigeerimiseks sisestage kõik read!')
        end
	end
end)

RegisterNUICallback("refreshVehiclesButton", function(args, cb)
	lib.callback('kk-society:getVehicles', false, function(cb) 
		SendNUIMessage({ action = "loadVehicles", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNUICallback("refreshBankButton", function(args, cb)
	lib.callback('kk-society:getMoneyCompany', false, function(cb)
		SendNUIMessage({ action = "updateBankTabData", data = cb })
	end, ESX.PlayerData.job.name)
end)

RegisterNetEvent('kk-society:client:showNotify')
AddEventHandler('kk-society:client:showNotify', function(title, text, type)
	SendNUIMessage({ 
		action = 'showNotification', 
		data = {
			title = title,
			text = text,
			type = type
		}
	})
end)

----------------------------------------------------------------------------------

local function openGarage(name, type)
    lib.callback('kk-garage:getSocietyVehicles', false, function(vehicles)
        local elements = {}

        for k,v in pairs(vehicles) do
            if v.type == type then
                local vehData = json.decode(v.vehicle) 

                if v.stored then
                    local vehicleLabel = GetDisplayNameFromVehicleModel(vehData.model); vehicleLabel = GetLabelText(vehicleLabel)

                    elements[v.plate] = {
                        description = vehicleLabel,
                        args = {plate = v.plate, data = vehData, name = name},
                        event = 'kk-society:client:spawnVehicle'
                    }
                end
            end
        end

        lib.registerContext({
            id = 'job_garage',
            title = 'Töösõidukite garaaz',
            options = elements
        })

        lib.showContext('job_garage')
    end, name, type)
end

RegisterNetEvent('kk-society:client:spawnVehicle', function(val)
	local triedSpawnPoints = {}
	local spawnPoint = nil
	local success = nil

	while true do
		local spawnID = math.random(#Config.Garages[val.name].spawnPoints)
		local spawn = Config.Garages[val.name].spawnPoints[spawnID]
		local isClear = ESX.Game.IsSpawnPointClear(spawn, 2.5)

		if isClear then
			success = true
			spawnPoint = spawn
			break
		else
			triedSpawnPoints[spawnID] = true
			success = false
		end

		if #triedSpawnPoints == #Config.Garages[val.name].spawnPoints then
			success = false
			TriggerEvent('KKF.UI.ShowNotification',"error", "Parklas pole ühtegi vaba parkimiskohta.")
			break
		end

		Wait(50)
	end
	
	lib.callback('KKF.Vehicle.SpawnOwnedVehicle', 500, function(networkId)
		if not networkId then 
			TriggerServerEvent('esx:clientLog', PlayerId() .. ' | Sõiduki väljastamine | ERROR')
			TriggerEvent('KKF.UI.ShowNotification', "error", "Tekkis viga!")
			return 
		end 

		while not NetworkDoesEntityExistWithNetworkId(networkId) do
			Wait(10)
		end

		TriggerEvent('KKF.UI.ShowNotification', "success", "Sõiduk väljastatud garaazist!")
	end, val.plate, spawnPoint)
end)

function loadLoops()
	while ESX.PlayerData.job == nil do
		Wait(20)
	end
	
	CreateThread(function()
		local alreadyEnteredZone = false
		local text = '[E] - Ava garaaz'

		while true do
			wait = 5
			local ped = PlayerPedId()
			local inZone = false

			for k,v in pairs(Config.Garages) do
				if v.job == ESX.PlayerData.job.name and ESX.PlayerData.job.onDuty and ESX.PlayerData.job.permissions.garage then
					local dist = #(GetEntityCoords(ped) - vector3(v.spawnPos.x, v.spawnPos.y, v.spawnPos.z))

					if dist <= 3.0 then
						if not IsPedInAnyVehicle(ped) then
							wait = 5
							inZone  = true
							
							if IsControlJustPressed(0, 38) and not IsPedInAnyVehicle(ped) then openGarage(k, v.type) end

							break
						end
					else
						wait = 2000
					end
				else
					wait = 2000
				end
			end
			
			if inZone and not alreadyEnteredZone and not IsPedInAnyVehicle(ped)  then
				alreadyEnteredZone = true
				lib.showTextUI(text, {position = "left-center"})
			end

			if not inZone and alreadyEnteredZone then
				alreadyEnteredZone = false
				lib.hideTextUI()
			end

			Wait(wait)
		end
	end)

	CreateThread(function()
		local alreadyEnteredZone = false
		local text = '[E] - Hoiusta sõiduk'

		while true do
			wait = 5
			local ped = PlayerPedId()
			local inZone = false

			for k,v in pairs(Config.Garages) do
				if v.job == ESX.PlayerData.job.name and ESX.PlayerData.job.onDuty and ESX.PlayerData.job.permissions.garage then
					local dist = #(GetEntityCoords(ped) - vector3(v.deletePos.x, v.deletePos.y, v.deletePos.z))

					if dist <= 3.0 then
						wait = 5
						inZone  = true

						if IsControlJustPressed(0, 38) and IsPedInAnyVehicle(ped) then
							local vehicle = GetVehiclePedIsIn(ped, false)
						
							lib.callback('KKF.Vehicle.DeleteOwnedVehicle', 500, function(status)
								if status then
									TriggerEvent('KKF.UI.ShowNotification', "success","Sõiduk edukalt hoiustatud!")
								else
									TriggerEvent('KKF.UI.ShowNotification', "error","Tundub, et sõiduk ei kuulu teile!")
								end
							end, ESX.Game.GetVehicleProperties(vehicle))
						end

						break
					else
						wait = 2000
					end
				else
					wait = 2000
				end
			end
			
			if inZone and not alreadyEnteredZone and IsPedInAnyVehicle(ped) then
				alreadyEnteredZone = true
				lib.showTextUI(text, {position = "left-center"})
			end

			if not inZone and alreadyEnteredZone then
				alreadyEnteredZone = false
				lib.hideTextUI()
			end

			Wait(wait)
		end
	end)
end
